# AI 면접 시스템 통합 테스트 및 질문 생성 고도화 분석 보고서

## 1. USER Objective (사용자 요구사항)

- **핵심 목표**: 이력서 데이터를 단순히 참고하는 수준을 넘어, 질문에 실질적으로 '녹여내는' 초개인화(Hyper-Personalization) 면접 질문 생성.
- **주요 요청 사항**:
  - 이력서 기반 디테일 확보: 지원자의 학력(전공, 학교명), 프로젝트 경험 등을 직접 인용하여 질문할 것. (예: "세종대학교에서 정보보호학을 전공하셨는데, 보안 엔지니어 직무에 가장 필요한 수업은?")
  - 실시간 꼬리질문 강화: 사용자의 답변에 따라 논리적으로 파고드는 꼬리질문 생성.
  - 시나리오 연동: `interview_scenario.py`에 정의된 단계별 의도(Guide)가 LLM 프롬프트에 정확히 반영되도록 개선.

---

## 2. 코드 현황 및 상세 분석 (Technical Analysis)

### A. 시나리오 설정 파일 (`interview_scenario.py`) 분석

- **현상**: 현재 가이드(`guide`) 필드가 "기술적 원리를 물어볼 것" 수준으로 추상적임.
- **문제점**: 지침이 모호하여 LLM이 이력서의 구체적인 텍스트(고유 명사)를 활용하지 않고 일반적인 직무 지식만 묻게 됨.
- **개선안**: 가이드를 '데이터 바인딩 지침'으로 보완. (예: "전공명, 기술명 중 하나를 반드시 문장 서두에 언급하여 질문을 시작할 것")

### B. 질문 생성 로직 (`question_generator.py`) 분석

- **현상**: `PROMPT_TEMPLATE`에 "실제 명칭을 써라"는 지시가 있으나, 강제성이 부족함.
- **문제점**:
  - RAG(검색) 단계에서 `top_k=2`로 너무 적은 조각만 가져와 인적 사항(학교, 전공)을 놓칠 확률이 있음.
  - 프롬프트 스타일 가이드에 구체적인 문장 패턴(패턴 유도)이 부족함.
- **개선안**:
  - **프롬프트 강화**: "일반적인 질문은 0점이다. 지원자만이 답할 수 있는 고유 명사가 포함된 질문이 100점이다"와 같은 페널티/보상을 프롬프트에 명시.
  - **RAG 최적화**: 이력서 전체를 요약한 '프로필 요약(Profile Summary)'을 컨텍스트 최상단에 고정하여 학교명 등이 누락되지 않도록 함.

### C. 실시간 STT 및 자막 경로 분석 (02/13 수정 완료 사항)

- **현상**: DB에는 저장되나 화면 자막이 안 나오던 문제.
- **원인**: `media-server`가 Celery 태스크(STT)를 던지기만 하고 결과를 받아 WebSocket으로 전달하는 '브릿지 로직'이 없었음.
- **조치**: `media-server/main.py`에서 `asyncio.to_thread`와 `task.get()`을 사용하여 실시간으로 결과를 낚아채 WebSocket으로 전달하도록 수정 완료.

---

## 3. 통합 테스트 케이스 설계 (Excel 기록용)

| ID           | 테스트 항목 | 테스트 시나리오            | 예상 결과 (Expected Result)                                         |
| :----------- | :---------- | :------------------------- | :------------------------------------------------------------------ |
| **P1** | 이력서 파싱 | 52번 이력서(세종대) 업로드 | 학력/전공 데이터가 JSON 구조화되어 저장됨                           |
| **P2** | 실시간 STT  | 답변 시작 후 음성 입력     | **2초 간격으로 화면에 실시간 자막 노출 (WebSocket)**          |
| **P3** | 개인화 질문 | 3단계(직무지식) 진입       | **"세종대학교 정보보안..."과 같이 학교/전공이 질문에 포함됨** |
| **P4** | 꼬리질문    | 이전 답변에 대한 추가 질문 | 사용자가 언급한 특정 키워드를 다시 물어봄 (STT 결과 연동)           |
| **P5** | 평가 리포트 | 모든 질문 완료 후 종료     | STAR 기법에 근거한 시니어 면접관 톤의 레포트 생성                   |

---

## 4. 향후 상세 수정 계획 (Action Plan) - 고도화 추가 (02/13)

### 단계 4: 다중 경험 연결형 질문 (Experience Linking) 분석

- **분석 사례**: "KISA 인턴 경험" + "더존 아카데미 프로젝트"를 엮어서 질문하는 방식.
- **수정 방향**:
  1. **시나리오 필터 제거**: `experience` 단계의 `category`를 `project`에서 `None`으로 변경하여 모든 활동(인턴, 교육 등)을 검색 대상으로 확장.
  2. **컨텍스트 확장**: `top_k`를 상향(3 -> 5)하여 서로 떨어진 위치의 경험 조각들을 LLM이 동시에 파악할 수 있게 함.
  3. **프롬프트 지시 추가**: "지원자의 이력서에서 발견되는 두 가지 이상의 주요 활동(A와 B)을 서로 연결하여 질문을 구성하라"는 핵심 지침 삽입.
  4. **페르소나 심화**: 지원자의 성장을 추적하고 맥락을 이해하는 '전략적 면접관'의 페르소나 적용.

### 단계 6: 가치관 및 동기 정밀분석 (Direct Quote Q1)

- **분석 사례**: 자기소개서 1번 문항(지원 동기 및 가치관)의 '보안 사고 목격 경험'과 '무결점 탐지' 목표를 연계하여 질문.
- **주요 예시**: "중학생 시절 지인의 피해를 계기로 '무결점 탐지'를 사명감으로 가졌다고 하셨는데, 실제 업무의 기술적 한계 속에서도 이 책임감을 어떻게 지켜낼 것인가요?"
- **수정 방향**:
  1. **시나리오 지침**: `responsibility` 가이드에 "자기소개서 1번 문항의 특정 경험(동기)과 목표를 인용할 것"을 명시.
  2. **데이터 매핑**: `stage_name == "responsibility"` 일 때 자기소개서 1번 데이터를 최우선 컨텍스트로 제공하도록 `question_generator.py` 수정.

### 단계 7: 세션 만료(401 Unauthorized) 트러블슈팅 및 조치

- **현상**: 면접 중 답변 제출 시 `POST /transcripts` API에서 `401 Unauthorized` 에러 발생.
- **원인 분석**:
  1. 백엔드의 JWT 토큰 기본 만료 시간이 30분으로 설정되어 있음.
  2. 면접 세션이 길어질 경우(RAG 연동 및 AI 질문 생성 대기 등) 토큰이 만료되어 인증이 필요한 API 호출이 거부됨.
- **조치 사항**:
  1. **환경 변수 추가**: `.env` 파일에 `ACCESS_TOKEN_EXPIRE_MINUTES=120`을 추가하여 토큰 유효 기간을 2시간으로 연장.
  2. **백엔드 로직 확인**: `auth_utils.py`에서 환경 변수를 동적으로 읽어오도록 설정되어 있음을 확인.

### 단계 8: 질문 간결화 정책 (2문장 제한) 반영

- **설정 배경**: 면접관의 발화가 길어지면 지원자의 집중도가 떨어지고 문맥 파악이 어려워질 수 있음.
- **조치 사항**:
  1. **프롬프트 절대 규칙 추가**: `PROMPT_TEMPLATE` 최상단에 "2문장 초과 금지" 및 "서론/인사 생략" 지침 배치.
  2. **발화 패턴 최적화**: "인용 + 질문"이라는 핵심 구조만 남기고 사족을 제거하도록 LLM 가이드 강화.
- **기대 효과**: 정중하면서도 군더더기 없는 '시니어 면접관' 특유의 날카로운 질문 스타일 구현.

### 단계 9: 리포트 저장 실패(Report Not Found) 상세 분석 및 해결

- **현상**: 면접을 정상적으로 종료했음에도 불구하고, 프론트엔드에서 리포트를 불러오지 못하거나 DB(`evaluation_reports`)에 데이터가 쌓이지 않는 현상 발생.
- **상세 분석 (Root Cause Analysis)**:
  1. **태스크 큐 격리 문제**: `backend-core/routes/interviews.py`에서 면접 종료 시 호출하는 `generate_final_report` 태스크가 `queue='gpu_queue'`로 명시적으로 지정되어 있었음.
  2. **워커 가용성 불일치**: 일반적인 로컬 개발 환경이나 기본 컨테이너 셋업에서는 `celery` 워커가 별도의 옵션 없이 실행되어 기본 큐만 모니터링함. 이로 인해 `gpu_queue`에 들어간 리포트 생성 요청은 '처리 대기(Pending)' 상태로 무한 정체됨.
  3. **프론트엔드 타임아웃**: 태스크가 처리되지 않으니 DB 레코드가 생성되지 않고, 프론트엔드의 폴링 로직은 최종적으로 404 에러를 받으며 리포트 표시를 포기하게 됨.
- **해결 방안 및 조치 사항**:
  1. **큐 전용 요건 제거**: `interviews.py` 소스 코드에서 `send_task` 호출 시 `queue='gpu_queue'` 파라미터를 삭제. 이를 통해 특정 장비(GPU) 유무와 상관없이 가용 가능한 모든 워커가 즉시 리포트 분석에 참여할 수 있도록 수정.
  2. **폴링 안정화**: 큐 병목이 해소됨에 따라 면접 종료 즉시 분석 태스크가 CPU 워커에 할당되고, 수 초 내에 `evaluation_reports` 테이블에 결과가 성공적으로 저장됨을 확인.

### 단계 10: 리포트 내 정보 미상(Unknown) 표시 오류 수정

- **현상**: 면접 결과 리포트 상단에 "회사명 미상", "직무 미상", "지원자 미상" 등으로 표시되는 문제 발생.
- **상세 분석 (Root Cause Analysis)**:
  1. **응답 모델 스키마 정보 부족**: `get_evaluation_report` API가 사용하는 `EvaluationReportResponse` 모델에 점수 데이터만 정의되어 있고, 표시용 메타데이터(직무, 회사명 등) 필드가 누락됨.
  2. **데이터 결합(Join) 누락**: 백엔드 라우터 로직에서 `EvaluationReport` 테이블만 단독 조회하고, 실제 정보가 담긴 `Interview`, `Company`, `User` 테이블과의 연동 로직이 부재함.
- **해결 방안 및 조치 사항**:
  1. **Response 모델 확장**: `db_models.py` 내 `EvaluationReportResponse` 클래스에 `position`, `company_name`, `candidate_name`, `interview_date` 필드를 추가.
  2. **백엔드 로직 보강**: `backend-core/routes/interviews.py`의 조회 엔드포인트에서 `db.get()`을 사용하여 관련 테이블 정보를 매핑하고, 프론트엔드가 즉시 렌더링할 수 있는 완전한 객체 형태로 반환하도록 수정.
- **기대 효과**: 지원자의 이력서 및 면접 세션 정보가 리포트에 정확히 반영되어 맞춤형 리포트 경험 제공.

---

**보고자: Antigravity AI**
**일시: 2026-02-13**
