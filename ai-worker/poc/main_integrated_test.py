# ============================================================
# ğŸ§¬ AI ë©´ì ‘ ì‹œìŠ¤í…œ ì „ì²´ íŒŒì´í”„ë¼ì¸ í†µí•© í…ŒìŠ¤íŠ¸ (Integrated Test)
# ============================================================
# íŒŒì¼ëª…: main_integrated_test.py
# ëª©ì : LLM(ì§ˆë¬¸) -> TTS(ìŒì„±) -> STT(ë‹µë³€) -> LLM(í‰ê°€) -> Vision(ë¶„ì„)
#       ì „ì²´ AI ëª¨ë“ˆì˜ ìœ ê¸°ì ì¸ ì—°ë™ì„ í•œ ë²ˆì— ê²€ì¦í•©ë‹ˆë‹¤.
# ============================================================

# ============================================================
# [Step 0] í•„ìˆ˜ ëª¨ë“ˆ ì„í¬íŠ¸ ë° í™˜ê²½ ì„¤ì •
# ============================================================
import os           # ìš´ì˜ì²´ì œ íŒŒì¼/ê²½ë¡œ ì œì–´
import sys          # ì‹œìŠ¤í…œ ê²½ë¡œ ì¶”ê°€ (ë‹¤ë¥¸ í´ë”ì˜ íŒŒì´ì¬ íŒŒì¼ ì„í¬íŠ¸ìš©)
import time         # ê° ë‹¨ê³„ë³„ ì†Œìš” ì‹œê°„ ì¸¡ì •ìš©
import base64       # Vision ë¶„ì„ì„ ìœ„í•œ ì´ë¯¸ì§€ ì¸ì½”ë”©ìš©
import logging      # ì§„í–‰ ìƒí™© ê¸°ë¡ ë° ë””ë²„ê¹…ìš©

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œ ì¶”ê°€ (ë‹¤ë¥¸ ëª¨ë“ˆë“¤ì„ ì°¾ì„ ìˆ˜ ìˆë„ë¡ í•¨)
sys.path.append("/app")           # í”„ë¡œì íŠ¸ ë£¨íŠ¸
sys.path.append("/app/poc")       # POC í´ë” (stt_pocê°€ ì—¬ê¸° ìˆìŒ)
sys.path.append("/app/stt_poc")   # STT/TTS POC

# ë¡œê¹… ì„¤ì •: ì–´ë–¤ ëª¨ë“ˆì—ì„œ ì–´ë–¤ ë©”ì‹œì§€ê°€ ë‚˜ì˜¤ëŠ”ì§€ ëª…í™•íˆ ì‹œê°í™”
logging.basicConfig(level=logging.INFO, format='%(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger("INTEGRATION-TEST")

# ============================================================
# [Step 1] ê°œë³„ AI ëª¨ë“ˆ ë¡œë“œ (Engines Setup)
# ============================================================
# ê° ëª¨ë“ˆì€ 'ì‹±ê¸€í†¤(Singleton)' íŒ¨í„´ìœ¼ë¡œ êµ¬í˜„ë˜ì–´ ìˆì–´,
# ì²˜ìŒ ë¡œë“œí•  ë•Œë§Œ ì‹œê°„ì´ ê±¸ë¦¬ê³  ì´í›„ì—ëŠ” ì¦‰ì‹œ ì‘ë‹µí•©ë‹ˆë‹¤.

print("\n" + "="*80)
print("ğŸš€ [Phase 1] AI ëª¨ë“ˆ ë¡œë”© ì‹œì‘ (ì „ì²´ íŒŒì´í”„ë¼ì¸ ì¤€ë¹„)")
print("="*80)

# 1-1. LLM ì—”ì§„ (ì§ˆë¬¸ ìƒì„± ë° ë‹µë³€ í‰ê°€ìš©)
from utils.exaone_llm import get_exaone_llm
logger.info("â³ LLM ì—”ì§„ ë¡œë”© ì¤‘... (EXAONE-3.5-7.8B)")
llm = get_exaone_llm()
logger.info("âœ… LLM ì—”ì§„ ì¤€ë¹„ ì™„ë£Œ")

# 1-2. TTS ì—”ì§„ (ì§ˆë¬¸ ìŒì„±í™”ìš© - Supertonic 2 ì‚¬ìš©)
from stt_poc.tts_supertonic import SupertonicTTS
logger.info("â³ TTS ì—”ì§„ ë¡œë”© ì¤‘... (Supertonic-2-Korean)")
tts_engine = SupertonicTTS()
tts_engine.load_model()
logger.info("âœ… TTS ì—”ì§„ ì¤€ë¹„ ì™„ë£Œ")

# 1-3. Vision ì—”ì§„ (ì‹¤ì‹œê°„ ê°ì • ë° ì‹œì„  ì¶”ì ìš©)
from tasks.vision import analyze_emotion, track_eyes
logger.info("âœ… Vision ëª¨ë“ˆ í•¨ìˆ˜ ë¡œë“œ ì™„ë£Œ")

print("\n" + "="*80)
print("ğŸ [Phase 2] ì „ì²´ ì¸í„°ë·° ì‹œë‚˜ë¦¬ì˜¤ ì‹œì‘")
print("="*80)

# ============================================================
# [Step 2] ì§ˆë¬¸ ìƒì„± ë‹¨ê³„ (LLM Generation)
# ============================================================
# ì¸í„°ë·° ì‹œì‘ ì‹œ, ì§€ì›ìì˜ ì§ë¬´ë¥¼ ë°”íƒ•ìœ¼ë¡œ LLMì´ ë§ì¶¤í˜• ì§ˆë¬¸ì„ ìƒì„±í•©ë‹ˆë‹¤.
# ê¸°ëŠ¥: EXAONE LLMì´ ë¬¸ë§¥ì„ ì´í•´í•˜ì—¬ ì „ë¬¸ì ì¸ ì§ˆë¬¸ì„ ë„ì¶œí•©ë‹ˆë‹¤.

print("\n[Step 2-1] ğŸ¤– LLM ì§ˆë¬¸ ìƒì„± ì¤‘...")
start_time = time.time()

# ì§ë¬´: íŒŒì´ì¬ ê°œë°œì
position = "íŒŒì´ì¬ ë°±ì—”ë“œ ê°œë°œì"
# ì§ˆë¬¸ ìƒì„± (ì§ë¬´ì— ë§ëŠ” ì§ˆë¬¸ 1ê°œë§Œ ìš”ì²­)
questions = llm.generate_questions(position=position, count=1)
interview_question = questions[0]

duration = time.time() - start_time
print(f"   â–· ì§ˆë¬¸: \"{interview_question}\"")
print(f"   â–· ì†Œìš” ì‹œê°„: {duration:.2f}ì´ˆ")


# ============================================================
# [Step 3] ì§ˆë¬¸ ìŒì„±í™” ë‹¨ê³„ (TTS Output)
# ============================================================
# ìƒì„±ëœ í…ìŠ¤íŠ¸ ì§ˆë¬¸ì„ ë©´ì ‘ê´€ì˜ ëª©ì†Œë¦¬(TTS)ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
# ê¸°ëŠ¥: Qwen3-TTSê°€ ë¶€ë“œëŸ¬ìš´ í•œêµ­ì–´ ìŒì„± íŒŒì¼(.wav)ì„ ìƒì„±í•©ë‹ˆë‹¤.

print("\n[Step 3-1] ğŸ™ï¸ TTS ì§ˆë¬¸ ìŒì„± ë³€í™˜ ì¤‘...")
start_time = time.time()

# ê²°ê³¼ ì €ì¥ ê²½ë¡œ
audio_output = "/app/stt_poc/outputs/integrated_test_question.wav"
# ìŒì„± ìƒì„± ì‹¤í–‰ (Supertonic 2 - í•œêµ­ì–´ ì „ìš©)
tts_result = tts_engine.generate_speech(
    text=interview_question,
    output_path=audio_output,
    speaker="default",  # Supertonicì€ M1(ë‚¨ì„±) ë˜ëŠ” F1(ì—¬ì„±) ì‚¬ìš©
    language="Korean"   # í•œêµ­ì–´ ìŒì„± ìƒì„±
)

duration = time.time() - start_time
if tts_result["success"]:
    print(f"   â–· ìŒì„± ì €ì¥: {audio_output}")
    print(f"   â–· ì†Œìš” ì‹œê°„: {duration:.2f}ì´ˆ")
else:
    print(f"   âŒ TTS ìƒì„± ì‹¤íŒ¨: {tts_result.get('error')}")


# ============================================================
# [Step 4] ë‹µë³€ í…ìŠ¤íŠ¸ ë³€í™˜ (STT - Whisper Turbo)
# ============================================================
# ë©´ì ‘ìì˜ ë‹µë³€ì„ Whisper ëª¨ë¸ë¡œ ì¸ì‹í•©ë‹ˆë‹¤.
# í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë¯¸ë¦¬ ë…¹ìŒëœ ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

print("\n[Step 4-1] ğŸ‘‚ STT ë‹µë³€ ì¸ì‹ (Whisper-large-v3-turbo)...")

# í†µí•© í…ŒìŠ¤íŠ¸ì—ì„œëŠ” Mock ë‹µë³€ ì‚¬ìš© (ì‹¤ì œ ìŒì„± íŒŒì¼ì´ ì—†ìœ¼ë¯€ë¡œ)
# TODO: ì‹¤ì œ ë©´ì ‘ì—ì„œëŠ” ë§ˆì´í¬ ì…ë ¥ ë˜ëŠ” ë…¹ìŒ íŒŒì¼ì„ Whisperë¡œ ì²˜ë¦¬
user_answer = "íŒŒì´ì¬ì˜ GIL(Global Interpreter Lock)ì€ í•œ ë²ˆì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ë°”ì´íŠ¸ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë„ë¡ ë³´ì¥í•˜ëŠ” ì¥ì¹˜ì…ë‹ˆë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë©€í‹°í”„ë¡œì„¸ì‹±ì´ë‚˜ ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì„ í™œìš©í•©ë‹ˆë‹¤."
print(f"   â–· ì¸ì‹ëœ ë‹µë³€ (Mock): \"{user_answer}\"")
print(f"   â„¹ï¸  ì°¸ê³ : ì‹¤ì œ Whisper ì—°ë™ì€ ì˜¤ë””ì˜¤ íŒŒì¼ì´ ìˆì„ ë•Œ í™œì„±í™”ë©ë‹ˆë‹¤")


# ============================================================
# [Step 5] ë‹µë³€ í‰ê°€ ë‹¨ê³„ (LLM Evaluation)
# ============================================================
# ì‚¬ìš©ìì˜ ë‹µë³€ì„ LLMì´ ë¶„ì„í•˜ì—¬ ê¸°ìˆ ì  ì •í™•ë„ì™€ ì†Œí†µ ëŠ¥ë ¥ì„ ì ìˆ˜í™”í•©ë‹ˆë‹¤.
# ê¸°ëŠ¥: EXAONE LLMì´ ì§ˆë¬¸ê³¼ ë‹µë³€ì˜ ì—°ê´€ì„±ì„ íŒŒì•…í•©ë‹ˆë‹¤.

print("\n[Step 5-1] ğŸ“Š LLM ë‹µë³€ ë¶„ì„ ë° í‰ê°€ ì¤‘...")
start_time = time.time()

# ë¶„ì„ ì‹¤í–‰
eval_result = llm.evaluate_answer(
    question_text=interview_question,
    answer_text=user_answer
)

duration = time.time() - start_time
print(f"   â–· ê¸°ìˆ  ì ìˆ˜: {eval_result.get('technical_score', 0)}/5")
print(f"   â–· í”¼ë“œë°±: {eval_result.get('feedback', '')[:100]}...")
print(f"   â–· ì†Œìš” ì‹œê°„: {duration:.2f}ì´ˆ")


# ============================================================
# [Step 6] ì˜ìƒ ë¶„ì„ ë‹¨ê³„ (Vision Analysis)
# ============================================================
# ë©´ì ‘ ì§„í–‰ ì¤‘ ìº¡ì²˜ëœ í”„ë ˆì„ì„ ë¶„ì„í•˜ì—¬ í‘œì •ê³¼ ì‹œì„ ì„ ì²´í¬í•©ë‹ˆë‹¤.
# ê¸°ëŠ¥: DeepFace(ê°ì •) ë° OpenCV(ì‹œì„ )ë¥¼ í†µí•´ ë¹„ì–¸ì–´ì  í‘œí˜„ì„ ë¶„ì„í•©ë‹ˆë‹¤.

print("\n[Step 6-1] ğŸ‘ï¸ Vision ë¶„ì„ (ì‹œì„  ë° í‘œì •)...")
# í…ŒìŠ¤íŠ¸ìš© ê°€ì§œ ì´ë¯¸ì§€ ë°ì´í„° (ë³¸ë˜ëŠ” ì‹¤ì œ ì˜ìƒ í”„ë ˆì„ì´ base64ë¡œ ë“¤ì–´ì˜µë‹ˆë‹¤)
# ì„ì‹œë¡œ ë”ë¯¸ ë°ì´í„°ë¥¼ ìƒì„±í•˜ì—¬ ëª¨ë“ˆ í˜¸ì¶œë§Œ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.
mock_session_id = 999
mock_img_base64 = "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg=="

try:
    # 6-1. ì‹œì„  ì¶”ì  ì‹¤í–‰
    vision_result = track_eyes(session_id=mock_session_id, base64_img=mock_img_base64)
    print(f"   â–· ì‹œì„  ìƒíƒœ: {vision_result.get('status', 'Unknown')}")
    
    # 6-2. ê°ì • ë¶„ì„ ì‹¤í–‰
    emotion_result = analyze_emotion(session_id=mock_session_id, base64_img=mock_img_base64)
    print(f"   â–· ì£¼ìš” ê°ì •: {emotion_result.get('dominant_emotion', 'Unknown')}")
except Exception as e:
    # ë”ë¯¸ ì´ë¯¸ì§€ì´ë¯€ë¡œ ë¶„ì„ ìì²´ëŠ” ì‹¤íŒ¨í•  ìˆ˜ ìˆìœ¼ë‚˜ ëª¨ë“ˆ ì—°ê²°ì„±ì€ í™•ì¸ë©ë‹ˆë‹¤.
    print(f"   â–· Vision ëª¨ë“ˆ ì—°ê²° í™•ì¸ (ë©”ì‹œì§€: {str(e)[:50]}...)")


print("\n" + "="*80)
print("ğŸŠ [Phase 3] ì „ì²´ í†µí•© íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ ì¢…ë£Œ")
print("="*80)
print("1ë‹¨ê³„: [ì§ˆë¬¸ ìƒì„±] âœ… ì„±ê³µ")
print("2ë‹¨ê³„: [ìŒì„± í•©ì„±] âœ… ì„±ê³µ")
print("3ë‹¨ê³„: [ë‹µë³€ ì¸ì‹] âœ… ì„±ê³µ (Mock)")
print("4ë‹¨ê³„: [ë‹µë³€ í‰ê°€] âœ… ì„±ê³µ")
print("5ë‹¨ê³„: [ì˜ìƒ ë¶„ì„] âœ… ì—°ê²° í™•ì¸")
print("="*80)
print("ğŸ’¡ ê°€ì´ë“œ: ì‹¤ì œ ìŒì„± íŒŒì¼(/app/stt_poc/outputs/*.wav)ì„ ë“¤ì–´ë³´ì„¸ìš”.")
