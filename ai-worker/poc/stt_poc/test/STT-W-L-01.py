"""
========================================
Whisper-Large-v3 ìŒì„± ì¸ì‹ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
========================================
ëª¨ë¸: openai/whisper-large-v3 (ì •í™•ë„ ìµœìš°ì„ )
ëª©ì : ìµœëŒ€ ì •í™•ë„ë¡œ í•œêµ­ì–´ ìŒì„± ì¸ì‹ ì„±ëŠ¥ ì¸¡ì •
ë¹„êµ: Turbo ë²„ì „ë³´ë‹¤ ëŠë¦¬ì§€ë§Œ ë” ì •í™•í•¨
========================================
"""
import numpy as np
import sounddevice as sd
from faster_whisper import WhisperModel
import time

print("=" * 60)
print("ğŸ¤ Whisper-Large-v3 ë¡œì»¬ ë§ˆì´í¬ í…ŒìŠ¤íŠ¸")
print("=" * 60)
print("\n[ì•Œë¦¼] ì´ í…ŒìŠ¤íŠ¸ëŠ” ë¡œì»¬ PC(CPU) í™˜ê²½ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.")
print("-" * 60)

# ============================================================
# [ë‹¨ê³„ 1] Whisper ëª¨ë¸ ë¡œë“œ
# ============================================================
print("\n[1/4] â³ Whisper-Large-v3 ëª¨ë¸ ë¡œë”© ì¤‘... (CPU ëª¨ë“œ)")
load_start = time.time()
try:
    # [í•µì‹¬] ì˜¤ë¦¬ì§€ë„ ê³ ì •ë°€ ëª¨ë¸ 'large-v3' ì‚¬ìš©
    model = WhisperModel("large-v3", device="cpu", compute_type="int8")
    load_elapsed = time.time() - load_start
    print(f"      âœ… CPU ëª¨ë“œ ë¡œë“œ ì™„ë£Œ! (ì†Œìš” ì‹œê°„: {load_elapsed:.2f}ì´ˆ)")
except Exception as e:
    print(f"      âŒ ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨: {e}")
    exit(1)

# ============================================================
# [ë‹¨ê³„ 2] ë…¹ìŒ ì„¤ì •
# ============================================================
# - SAMPLE_RATE: 16000Hz (Whisper ê¶Œì¥ ìƒ˜í”Œë§ ë ˆì´íŠ¸)
# - DURATION: 15ì´ˆ (ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ìš©)
# ============================================================
SAMPLE_RATE = 16000  
DURATION = 60  

print(f"\n[2/4] ğŸ™ï¸  ì‚¬ìš© ê°€ëŠ¥í•œ ë§ˆì´í¬ ëª©ë¡:")
print(sd.query_devices())

print(f"\n[3/4] ğŸ”´ {DURATION}ì´ˆê°„ ë…¹ìŒì„ ì‹œì‘í•©ë‹ˆë‹¤!")
print("      ì§€ê¸ˆ ê¸´ ë¬¸ì¥ìœ¼ë¡œ ë§ì”€í•´ì£¼ì„¸ìš”!")
print("      ì˜ˆ) 'ì•ˆë…•í•˜ì„¸ìš”, ì €ëŠ” ì¸ê³µì§€ëŠ¥ ë©´ì ‘ ì‹œìŠ¤í…œì„ í…ŒìŠ¤íŠ¸í•˜ê³  ìˆìŠµë‹ˆë‹¤.'")
print("-" * 60)

# ============================================================
# [ë‹¨ê³„ 2-1] ë…¹ìŒ ì‹œì‘ ì¹´ìš´íŠ¸ë‹¤ìš´ (3ì´ˆ)
# ============================================================
# - ì‚¬ìš©ìê°€ ì¤€ë¹„í•  ì‹œê°„ì„ ì£¼ê¸° ìœ„í•¨
# ============================================================
for i in range(3, 0, -1):
    print(f"      {i}...")
    time.sleep(1)
print("      ğŸ¤ ë…¹ìŒ ì‹œì‘!")

# ============================================================
# [ë‹¨ê³„ 3] ë§ˆì´í¬ ì…ë ¥ ë…¹ìŒ
# ============================================================
# - sd.rec(): sounddevice ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ì˜¤ë””ì˜¤ ë…¹ìŒ
# - channels=1: ëª¨ë…¸ ë…¹ìŒ (WhisperëŠ” ëª¨ë…¸ ê¶Œì¥)
# - dtype='float32': 32ë¹„íŠ¸ ë¶€ë™ì†Œìˆ˜ì  í¬ë§·
# ============================================================
try:
    audio_data = sd.rec(
        int(DURATION * SAMPLE_RATE),  # ì´ ìƒ˜í”Œ ìˆ˜ = 30ì´ˆ * 16000Hz
        samplerate=SAMPLE_RATE, 
        channels=1,  # Mono
        dtype='float32'
    )
    sd.wait()  # ë…¹ìŒ ì™„ë£Œê¹Œì§€ ëŒ€ê¸°
    print("      âœ… ë…¹ìŒ ì™„ë£Œ!\n")
    
    # ============================================================
    # [ë‹¨ê³„ 3-1] ë…¹ìŒëœ ì˜¤ë””ì˜¤ë¥¼ WAV íŒŒì¼ë¡œ ì €ì¥
    # ============================================================
    # - ëª©ì : ì¬ìƒí•´ì„œ ì‹¤ì œ ë…¹ìŒ í’ˆì§ˆ í™•ì¸ ê°€ëŠ¥
    # - íŒŒì¼ëª…: recorded_audio_large_v3.wav
    # ============================================================
    import scipy.io.wavfile as wav
    import os
    # í˜„ì¬ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆëŠ” í´ë” ê²½ë¡œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    script_dir = os.path.dirname(os.path.abspath(__file__))
    output_file = os.path.join(script_dir, "recorded_audio_large_v3.wav")
    
    wav.write(output_file, SAMPLE_RATE, audio_data)
    print(f"      ğŸ’¾ ë…¹ìŒ íŒŒì¼ ì €ì¥: {output_file}")
    print(f"         â†’ ì´ íŒŒì¼ì„ ì¬ìƒí•´ì„œ ì‹¤ì œë¡œ ë­ê°€ ë…¹ìŒëëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”!\n")
except Exception as e:
    print(f"      âŒ ë…¹ìŒ ì‹¤íŒ¨: {e}")
    print("\nê°€ëŠ¥í•œ ì›ì¸:")
    print("  - ë§ˆì´í¬ ê¶Œí•œì´ ì—†ìŒ")
    print("  - ë§ˆì´í¬ê°€ ì—°ê²°ë˜ì§€ ì•ŠìŒ")
    exit(1)

# ============================================================
# [ë‹¨ê³„ 4] Whisperë¡œ ìŒì„± ì¸ì‹ (í•µì‹¬ ë‹¨ê³„)
# ============================================================
# - audio_array: 2D ë°°ì—´ì„ 1Dë¡œ ë³€í™˜ (N, 1) -> (N,)
# - transcribe(): Whisper ëª¨ë¸ì´ ìŒì„±ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
# - language="ko": í•œêµ­ì–´ ì§€ì • (ì¸ì‹ ì •í™•ë„ í–¥ìƒ)
# - vad_filter=False: ë¬´ìŒ í•„í„° ë„ê¸° (ëª¨ë“  ì˜¤ë””ì˜¤ ì²˜ë¦¬)
# ============================================================
print("[4/4] ğŸ” Whisper-Large-v3ê°€ ìŒì„±ì„ ë¶„ì„í•˜ëŠ” ì¤‘...")
audio_array = audio_data.flatten()  # (N, 1) -> (N,) ë³€í™˜

# ============================================================
# [ë‹¨ê³„ 4-1] ì˜¤ë””ì˜¤ ë ˆë²¨ ì§„ë‹¨
# ============================================================
# - ëª©ì : ë§ˆì´í¬ ë³¼ë¥¨ì´ ì¶©ë¶„í•œì§€ í™•ì¸
# - ì •ìƒ ë²”ìœ„: ìµœëŒ€ ë³¼ë¥¨ 0.1 ~ 0.5
# ============================================================
audio_max = np.abs(audio_array).max()
audio_mean = np.abs(audio_array).mean()
print(f"      ğŸ“Š ì˜¤ë””ì˜¤ ë ˆë²¨ ì²´í¬:")
print(f"         ìµœëŒ€ ë³¼ë¥¨: {audio_max:.4f}")
print(f"         í‰ê·  ë³¼ë¥¨: {audio_mean:.4f}")

if audio_max < 0.01:
    print(f"      âš ï¸  ê²½ê³ : ì˜¤ë””ì˜¤ ë ˆë²¨ì´ ë§¤ìš° ë‚®ìŠµë‹ˆë‹¤! ë§ˆì´í¬ ë³¼ë¥¨ì„ ë†’ì´ì„¸ìš”.")

# ============================================================
# [ë‹¨ê³„ 4-2] Whisper ìŒì„± ì¸ì‹ ì‹¤í–‰
# ============================================================
# - ì²˜ë¦¬ ì‹œê°„ ì¸¡ì • (Turboì™€ ë¹„êµìš©)
# ============================================================
start_time = time.time()
segments, info = model.transcribe(
    audio_array, 
    language="ko",  # í•œêµ­ì–´ ì§€ì •
    vad_filter=False  # VAD í•„í„° ë„ê¸° - ëª¨ë“  ì˜¤ë””ì˜¤ ì²˜ë¦¬
)

# ============================================================
# [ë‹¨ê³„ 5] ì¸ì‹ ê²°ê³¼ ì¶œë ¥ ë° ë¶„ì„
# ============================================================
# - segments: ìŒì„± êµ¬ê°„ë³„ í…ìŠ¤íŠ¸ ë¦¬ìŠ¤íŠ¸
# - ê° segmentëŠ” ì‹œì‘ì‹œê°„, ì¢…ë£Œì‹œê°„, í…ìŠ¤íŠ¸ í¬í•¨
# ============================================================
print("=" * 60)
print("ğŸ“ ì¸ì‹ ê²°ê³¼")
print("=" * 60)

text_parts = []
segment_count = 0

# ê° ì„¸ê·¸ë¨¼íŠ¸ ì¶œë ¥ (íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨)
for segment in segments:
    segment_count += 1
    print(f"  [{segment.start:.2f}s - {segment.end:.2f}s] {segment.text}")
    text_parts.append(segment.text)

elapsed = time.time() - start_time

# ì „ì²´ í…ìŠ¤íŠ¸ ê²°í•©
full_text = " ".join(text_parts).strip()

print("=" * 60)
if full_text:
    print("âœ… ìµœì¢… ì¸ì‹ í…ìŠ¤íŠ¸:")
    print(f"   '{full_text}'")
    print(f"\nâ±ï¸  ëª¨ë¸ ë¡œë”© ì‹œê°„: {load_elapsed:.2f}ì´ˆ")
    print(f"â±ï¸  ìŒì„± ì¸ì‹ ì‹œê°„: {elapsed:.2f}ì´ˆ")
    print(f"ğŸ“Š ì„¸ê·¸ë¨¼íŠ¸ ìˆ˜: {segment_count}ê°œ")
    
    # ============================================================
    # [ë‹¨ê³„ 6] ì •í™•ë„ ì¸¡ì • (ì„ íƒì‚¬í•­)
    # ============================================================
    # - ì‚¬ìš©ìê°€ ì‹¤ì œë¡œ ë§í•œ ë‚´ìš©ê³¼ ë¹„êµ
    # - ë¬¸ì ë‹¨ìœ„ ë° ë‹¨ì–´ ë‹¨ìœ„ ì •í™•ë„ ê³„ì‚°
    # ============================================================
    print("\n" + "=" * 60)
    print("ğŸ“ˆ ì •í™•ë„ ì¸¡ì • (ì„ íƒ)")
    print("=" * 60)
    ground_truth = input("ì‹¤ì œë¡œ ë§í•œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (EnterëŠ” ê±´ë„ˆë›°ê¸°): ").strip()
    
    if ground_truth:
        # ============================================================
        # [í•¨ìˆ˜] ë¬¸ì ë‹¨ìœ„ ì •í™•ë„ ê³„ì‚°
        # ============================================================
        # - difflib.SequenceMatcher: ë‘ ë¬¸ìì—´ì˜ ìœ ì‚¬ë„ ê³„ì‚°
        # - ê³µë°± ì œê±° í›„ ì†Œë¬¸ìë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ
        # ============================================================
        def calculate_char_accuracy(reference, hypothesis):
            ref = reference.replace(" ", "").lower()
            hyp = hypothesis.replace(" ", "").lower()
            
            if len(ref) == 0:
                return 0.0
            
            import difflib
            similarity = difflib.SequenceMatcher(None, ref, hyp).ratio()
            return similarity * 100
        
        # ============================================================
        # [í•¨ìˆ˜] ë‹¨ì–´ ë‹¨ìœ„ ì •í™•ë„ ê³„ì‚°
        # ============================================================
        # - ë¬¸ì¥ì„ ë‹¨ì–´ë¡œ ë¶„ë¦¬í•˜ì—¬ ë¹„êµ
        # ============================================================
        def calculate_word_accuracy(reference, hypothesis):
            ref_words = reference.split()
            hyp_words = hypothesis.split()
            
            if len(ref_words) == 0:
                return 0.0
            
            import difflib
            similarity = difflib.SequenceMatcher(None, ref_words, hyp_words).ratio()
            return similarity * 100
        
        # ì •í™•ë„ ê³„ì‚° ì‹¤í–‰
        char_acc = calculate_char_accuracy(ground_truth, full_text)
        word_acc = calculate_word_accuracy(ground_truth, full_text)
        
        # ê²°ê³¼ ì¶œë ¥
        print(f"\nğŸ“Š ì •ë‹µ ë¬¸ì¥: '{ground_truth}'")
        print(f"ğŸ¤– ì¸ì‹ ë¬¸ì¥: '{full_text}'")
        print(f"\nâœ¨ ë¬¸ì ì •í™•ë„: {char_acc:.1f}%")
        print(f"âœ¨ ë‹¨ì–´ ì •í™•ë„: {word_acc:.1f}%")
        
        # ì„±ëŠ¥ í‰ê°€ ì¶œë ¥
        if char_acc >= 90:
            print(f"ğŸ‰ í‰ê°€: ë§¤ìš° ìš°ìˆ˜! (90% ì´ìƒ)")
        elif char_acc >= 70:
            print(f"ğŸ‘ í‰ê°€: ì–‘í˜¸ (70% ì´ìƒ)")
        elif char_acc >= 50:
            print(f"âš ï¸  í‰ê°€: ë³´í†µ (50% ì´ìƒ)")
        else:
            print(f"âŒ í‰ê°€: ê°œì„  í•„ìš” (50% ë¯¸ë§Œ)")
        
        # Turbo ë²„ì „ê³¼ ë¹„êµ ì•ˆë‚´
        print(f"\nğŸ’¡ ë¹„êµ íŒ:")
        print(f"   - Turbo ë²„ì „ íŒŒì¼: local_mic_test.py")
        print(f"   - v3 ë²„ì „ íŒŒì¼: local_mic_test_whisper_large_v3.py (í˜„ì¬)")
        print(f"   - ë‘ íŒŒì¼ì„ ì‹¤í–‰í•´ì„œ ì •í™•ë„ì™€ ì†ë„ë¥¼ ë¹„êµí•˜ì„¸ìš”!")
else:
    print("âš ï¸  ì¸ì‹ëœ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤.")
    print("\nê°€ëŠ¥í•œ ì›ì¸:")
    print("  1. ë§ˆì´í¬ ì†Œë¦¬ê°€ ë„ˆë¬´ ì‘ìŒ")
    print("  2. ë¬´ìŒì´ì—ˆìŒ")
    print("  3. VAD(ìŒì„± ê°ì§€) í•„í„°ì— ê±¸ë¦¼")
    print("\ní•´ê²°ì±…:")
    print("  - vad_filter=Falseë¡œ ë³€ê²½í•˜ê±°ë‚˜")
    print("  - ë§ˆì´í¬ì— ë” ê°€ê¹Œì´ì„œ í¬ê²Œ ë§í•´ë³´ì„¸ìš”")
print("=" * 60)
