{"id":-1,"name":"Onboarding diagram","userId":-1,"createdAt":"","updatedAt":"","content":{"items":[{"uid":"l5Wh0V33vq","position":{"x":-270,"y":-1950},"sizes":{"width":720,"height":1400},"autoheight":false,"blockContent":{"content":[{"type":"filePathNode","attrs":{"pathToFile":"","version":1},"content":[{"type":"text","marks":[{"type":"bold"}],"text":"ai-worker\\tasks\\resume_embedding.py"}]},{"type":"codeBlock","attrs":{"language":"python","wrapCode":true},"content":[{"type":"text","text":"\r\nimport logging\r\nimport json\r\nfrom datetime import datetime\r\nfrom celery import shared_task\r\nfrom sqlmodel import Session\r\nfrom db import engine\r\nfrom db_models import Resume\r\nfrom .embedding import embed_chunks\r\nfrom .chunking import chunk_resume\r\nfrom .pgvector_store import store_embeddings\r\n\r\nlogger = logging.getLogger(__name__)\r\n\r\n@shared_task(bind=True, name=\"tasks.resume_embedding.generate_resume_embeddings\", queue='gpu_queue')\r\ndef generate_resume_embeddings(self, resume_id: int):\r\n    \"\"\"\r\n    구조화된 이력서 데이터를 기반으로 청킹 및 임베딩을 생성하여 DB에 저장합니다.\r\n    \"\"\"\r\n    logger.info(f\"Starting resume embedding generation for ID: {resume_id}\")\r\n    \r\n    try:\r\n        with Session(engine) as session:\r\n            resume = session.get(Resume, resume_id)\r\n            if not resume:\r\n                logger.error(f\"Resume {resume_id} not found in DB\")\r\n                return\r\n\r\n            if not resume.structured_data:\r\n                logger.error(f\"Structured data is missing for resume {resume_id}\")\r\n                # Fallback: extracted_text 사용 시도?\r\n                if resume.extracted_text:\r\n                     # 텍스트라도 있으면 그걸로 청킹 시도 가능하지만,\r\n                     # 현재 chunking.py가 structured_data를 기대할 것임.\r\n                     pass \r\n                \r\n                # 데이터 없음 -> 실패 처리\r\n                resume.processing_status = \"failed\"\r\n                session.add(resume)\r\n                session.commit()\r\n                return\r\n            \r\n            # 1. 청킹\r\n            chunks = chunk_resume(resume.structured_data)\r\n            logger.info(f\"Created {len(chunks)} chunks for resume {resume_id}\")\r\n            \r\n            # 2. 임베딩 생성 (벡터 변환)\r\n            # embed_chunks는 [{\"text\":..., \"vector\":...}, ...] 리스트 반환\r\n            embedded_data = embed_chunks(chunks)\r\n            \r\n            if not embedded_data:\r\n                logger.error(f\"Failed to generate embeddings for resume {resume_id}\")\r\n                resume.processing_status = \"failed\"\r\n                session.add(resume)\r\n                session.commit()\r\n                return\r\n\r\n            # 3. 결과 저장\r\n            # 대표 벡터(첫 번째 청크 - 보통 Summary/Header)를 저장\r\n            # pgvector 컬럼(Vector(1024))에 맞게 저장\r\n            if embedded_data and 'vector' in embedded_data[0]:\r\n                 resume.embedding = embedded_data[0]['vector']\r\n                 logger.info(f\"Saved representative embedding vector (dim: {len(resume.embedding)})\")\r\n            \r\n            # 3. 벡터 DB(resume_embeddings 테이블)에 전체 청크 저장\r\n            try:\r\n                store_embeddings(resume_id, embedded_data)\r\n                logger.info(f\"Successfully stored {len(embedded_data)} chunks to vector DB\")\r\n            except Exception as e:\r\n                logger.error(f\"Failed to store chunks to vector DB: {e}\")\r\n                # 전체 저장은 실패해도 개별 상태는 completed로 감 (최소한 요약 벡터는 저장됨)\r\n            \r\n            # 완료 처리\r\n            resume.processing_status = \"completed\"\r\n            resume.processed_at = datetime.utcnow()\r\n            session.add(resume)\r\n            session.commit()\r\n            \r\n            logger.info(f\"Resume {resume_id} processing completed successfully.\")\r\n\r\n    except Exception as e:\r\n        logger.error(f\"Error generating embeddings for resume {resume_id}: {e}\", exc_info=True)\r\n        with Session(engine) as session:\r\n            resume = session.get(Resume, resume_id)\r\n            if resume:\r\n                resume.processing_status = \"failed\"\r\n                session.add(resume)\r\n                session.commit()"}]}]},"nodeType":"block"}],"configs":{"centerX":481.8184166934462,"centerY":1836.675394534144,"zoomLevel":0.79},"arrowData":{"arrowsMap":{"arrow-point-bI0wBh3Ufk-bottom-point-PSPLIYKa9J-top":{"to":"point-PSPLIYKa9J-top","from":"point-bI0wBh3Ufk-bottom","label":"Normal Box","direction":"ft","selectable":true},"arrow-point-bI0wBh3Ufk-bottom-point-ytXK_ayIc1-top":{"to":"point-ytXK_ayIc1-top","from":"point-bI0wBh3Ufk-bottom","label":"Code Box","direction":"ft","selectable":true},"arrow-point-hyyRZE3E8u-right-point-6ZopTaEaDZ-left":{"to":"point-6ZopTaEaDZ-left","from":"point-hyyRZE3E8u-right","label":"call","direction":"ft","selectable":true}},"pointsMap":{"point-PSPLIYKa9J-top":{"x":805.9999797489683,"y":60,"id":"point-PSPLIYKa9J-top","direction":"top"},"point-ytXK_ayIc1-top":{"x":205.99999493724206,"y":60,"id":"point-ytXK_ayIc1-top","direction":"top"},"point-6ZopTaEaDZ-left":{"x":220,"y":605.9999898744841,"id":"point-6ZopTaEaDZ-left","direction":"left"},"point-hyyRZE3E8u-right":{"x":100,"y":606,"id":"point-hyyRZE3E8u-right","direction":"right"},"point-bI0wBh3Ufk-bottom":{"x":515.9999797489683,"y":-40,"id":"point-bI0wBh3Ufk-bottom","direction":"bottom"}},"edgesMap":{}}}}