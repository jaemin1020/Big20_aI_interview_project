# 트러블슈팅: 면접 생성 시 회사 ID(company_id) 자동 매칭 이슈

## 1. 문제 상황 (Problem)
- 사용자가 이력서를 업로드하고 면접을 시작했으나, 데이터베이스의 `interviews` 테이블 내 `company_id` 컬럼이 계속 `NULL` 값으로 남아있는 현상 발생.
- 이력서 내에는 "안랩", "카카오" 등 지원 회사 이름이 명확히 추출되어 있음에도 불구하고 실제 DB 레코드와 연결되지 않음.

## 2. 원인 분석 (Root Cause)

### 1) 백엔드 로직 부재 (Initial Missing Logic)
- 기존 백엔드 코드(`routes/interviews.py`)는 프론트엔드에서 보내주는 `company_id`를 그대로 저장할 뿐, 이력서 텍스트에서 추출된 회사명을 DB ID로 변환하는 로직이 없었음.

### 2) 텍스트 불일치 문제 (String Mismatch)
- 이력서 추출 과정에서 회사명 앞뒤에 눈에 보이지 않는 **공백**이 포함될 경우 (예: `" 카카오 "`), DB에 저장된 실제 이름(`"카카오"`)과 일치하지 않아 매칭에 실패함.

### 3) 데이터 타입 및 인코딩 이슈
- DB의 `structured_data` 컬럼(JSONB)이 때때로 파이썬 객체가 아닌 문자열 형식으로 읽혀 데이터를 정상적으로 탐색하지 못하는 경우가 있었음.

### 4) 도커 환경의 코드 미반영 (Container Sync Issue)
- 소스 코드를 수정하더라도 도커 컨테이너가 이미 실행 중인 경우, 메모리 상의 이전 코드가 동작하여 수정 사항이 로그나 결과에 나타나지 않음.

## 3. 해결 과정 및 방법 (Resolution Steps)

### 단계 1: 백엔드 매칭 로직 추가
`backend-core/routes/interviews.py` 내 면접 생성 함수(`create_interview`)를 수정하여 자동 매칭 기능을 구현하였습니다.

### 단계 2: 견고한 전처리 및 검색 적용
- **공백 제거**: `.strip()` 함수를 사용하여 이름 앞뒤의 모든 공백을 제거 후 비교하도록 설정.
- **대소문자 무시 검색**: `func.lower()`를 사용하여 대소문자 차이로 인한 매칭 실패 방지.
- **안전한 JSON 파싱**: 데이터 형식에 상관없이 정보를 읽어올 수 있도록 다중 파싱 로직 적용.

### 단계 3: 검증용 스크립트를 통한 단계별 테스트
- `test_relationship.py`: DB 외래 키 제약 조건 및 기본 연결 확인.
- `check_company_capture.py`: 실제 공백이 포함된 텍스트로 매칭 알고리즘 검증.
- `debug_anhlab.py`: 특정 회사 데이터(안랩)의 바이트 단위 데이터 비교 및 디버깅.

### 단계 4: 도커 서버 재빌드 및 재시작
```bash
docker-compose up --build -d
```
- `--build` 옵션을 통해 수정된 파이썬 코드가 컨테이너 이미지에 확실히 반영되도록 조치.

## 4. 최종 결과 (Result)
- **성공 확인**: 새로운 면접 생성 시, 이력서의 "안랩" 텍스트를 인식하여 DB의 회사 ID(`53800`)를 자동으로 찾아내어 `interviews.company_id`에 정상적으로 저장함.
- **가시성 확보**: 서버 로그(`docker logs`)를 통해 매칭 성공 여부 및 추출된 회사명을 실시간으로 모니터링할 수 있도록 로깅 레벨 및 로그 메시지 강화.
