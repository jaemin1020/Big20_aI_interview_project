

# 📘 기술 상세 분석 보고서

## BIGTERVIEW 지능형 면접 추론 엔진

본 보고서는 실시간 AI 면접 시스템의 핵심 로직인 `generate_next_question_task`를 중심으로,
**입력 검증 → 문맥 검색 → 동적 추론 → 출력 정제 → 시스템 복원력**에 이르는 전 과정을 코드 수준에서 정밀 분석합니다.

---

## 1️⃣ 전처리 레이어: 입력 유효성 검증 (Input Guardrail)

AI가 엉뚱한 답변(환각)을 생성하지 않도록, 지원자의 입력을 사전에 필터링합니다.

```python
def is_meaningless(text: str) -> bool:
    """지원자의 답변이 무의미한지(자음 나열, 너무 짧음 등) 체크합니다."""
    if not text: return True
    # 1. 길이 및 자음 나열 체크
    if len(text) < 5: return True
    if re.fullmatch(r'[ㄱ-ㅎㅏ-ㅣ\s]+', text): return True
    # 2. 단순 특수문자/숫자 반복 (...., 123123 등)
    if re.fullmatch(r'[\.\,\!\?\-\=\s\d]+', text): return True
```

### 🔎 코드 분석

* `re.fullmatch()`를 사용해 **자음 나열, 특수문자 반복, 숫자 반복 패턴**을 정규식으로 차단
* 길이 기반 1차 필터링 + 패턴 기반 2차 필터링의 이중 구조

### 🎯 기술적 의도

* `"ㅋㅋㅋ"`, `"...."`, `"123123"` 같은 입력이 LLM으로 전달될 경우
  → “웃음이 많으시군요?” 같은 **맥락 왜곡 대화 흐름** 발생 가능
* 이를 사전 차단하여 **면접의 긴장감과 전문성 유지**

---

## 2️⃣ 전략 수립 레이어: 적응형 시나리오 판별

지원자의 전공/직무 배경에 따라 면접 난이도와 방향성을 동적으로 조정하는 로직입니다.

```python
# 전공/직무 기반 시나리오 결정
is_transition = check_if_transition(major, interview.position)
get_next_stage_func = get_next_stage_transition if is_transition else get_next_stage_normal

# 마지막 AI 발화의 question_type으로 현재 stage 판별
if last_ai_transcript and last_ai_transcript.question_id:
    last_stage_name = last_question.question_type if last_question else "intro"
```

### 🔎 코드 분석

* `is_transition` 변수로 **비전공자 여부 판별**
* 함수를 변수에 할당하여 동적으로 시나리오 호출 (전략 패턴과 유사)
* 이전 질문의 `question_type`을 기반으로 현재 단계 추론

### 🎯 기술적 의도

* 동일 직무라도 전공자/비전공자에 따라 질문 난이도 차별화
* 개인화된 면접 경험 제공
* 면접의 흐름이 단계적으로 이어지도록 상태 기반 설계

---

## 3️⃣ 문맥 엔진 레이어: 단계별 타겟 RAG

(Retrieval-Augmented Generation)

면접 목적에 따라 검색 쿼리를 실시간으로 생성하는 지능형 문맥 검색 구조입니다.

```python
behavioral_keywords = {
    "communication": "협업 사례, 팀 프로젝트 중 갈등 조율, 팀워크 발휘, 소통 능력",
    "growth": "자기계발 노력, 새로운 기술 학습 태도, 실패 극복 및 성장 사례",
    "responsibility": "직업 윤리, 약속 이행, 정직함과 관련된 경험"
}
target_query = behavioral_keywords.get(s_name, "본인의 강점, 성취감, 도전적인 경험 사례")
rag_results = retrieve_context(target_query, resume_id=interview.resume_id, top_k=2)
```

### 🔎 코드 분석

* `dict.get()`을 활용한 단계별 키워드 동적 선택
* `resume_id` 기반 벡터 DB 검색 수행
* `top_k=2`로 핵심 문맥만 추출

### 🎯 기술적 의도

* 단순한 일반 질문 방지
* 이력서 기반 **증거 중심 질문 생성**
* “성격이 어떤가요?” 대신
  → “A 프로젝트 협업 사례에서 갈등을 어떻게 조율하셨나요?”

---

## 4️⃣ 추론 제어 레이어: 하이퍼-프롬프트 엔지니어링

LLM의 행동을 강력한 제약 조건으로 통제합니다.

```python
if is_narrative:
    global_constraint = "인성 단계입니다. 코드, 설계, 개발과 같은 직무 단어를 사용하지 말고, 태도와 가치관을 인용하여 짧게 질문하십시오."

elif s_name == 'responsibility':
    mode_task_instruction = "자기소개서에서 나타난 지원자의 핵심 가치관을 파악하여... 80자 이내로 물으십시오."
```

### 🔎 코드 분석

* `global_constraint`와 `mode_task_instruction`을 동적 조립
* 질문 길이, 어휘 범위, 주제 영역을 명시적으로 제한

### 🎯 기술적 의도

* 인성 단계에서 기술 질문으로 탈선하는 현상 방지
* 질문 길이 과다 생성 방지
* 단계별 일관성 유지

---

## 5️⃣ 사후 정제 레이어: AI 말투 제거 (Sanitization)

LLM이 생성한 메타 발화 및 시스템 문구 제거

```python
meta_patterns = [
    r'(이\s*질문은|의도는|~라고\s*답변했다면|검증합니다|의도함|확인합니다|요구하여).*', 
    r'지원자가\s*.*라고\s*말했다면.*'
]
for pattern in meta_patterns:
    final_content = re.sub(pattern, '', final_content, flags=re.IGNORECASE | re.DOTALL)

quote_match = re.search(r'["\'“]([^"\'”]*\?+)["\'”]', final_content)
if quote_match:
    final_content = quote_match.group(1)
```

### 🔎 코드 분석

* `re.sub()`로 메타 문장 제거
* 따옴표 안 질문만 추출하는 정교한 패턴 매칭
* 불필요한 시스템 메시지 제거

### 🎯 기술적 의도

* “이 질문의 의도는…” 같은 시스템 노출 방지
* 실제 면접관과 대화하는 자연스러운 UX 유지

---

## 6️⃣ 시스템 회복력: 폴백(Fallback) 설계

LLM 추론 실패 시 면접이 중단되지 않도록 설계된 복원 전략입니다.

```python
except Exception as e:
    if self.request.retries >= 3:
        fallback_text = "[시스템 질문] AI 응답 지연으로 인해 기본 질문으로 대체합니다. ..."
        q_id = save_generated_question(content=fallback_text, stage="fallback", ...)
```

### 🔎 코드 분석

* Celery `retries` 횟수 체크
* 임계치 도달 시 하드코딩된 안전 질문 출력
* 질문 저장 로직까지 정상 플로우 유지

### 🎯 기술적 의도

* GPU 장애, 모델 지연 상황에서도 면접 지속 가능
* 사용자 경험 단절 방지
* 시스템 신뢰도 확보

---

# 🧠 종합 구조 요약

| 레이어      | 역할               | 핵심 기술           |
| ----------- | ------------------ | ------------------- |
| 입력 검증   | 무의미 답변 차단   | 정규식 필터링       |
| 전략 판별   | 전공 기반 시나리오 | 동적 함수 할당      |
| 문맥 엔진   | 단계별 RAG         | 벡터 검색           |
| 추론 제어   | LLM 행동 통제      | 제약 기반 프롬프트  |
| 사후 정제   | 메타 발화 제거     | 정규식 Sanitization |
| 시스템 복원 | 장애 대응          | Retry + Fallback    |

---

# 🚀 결론

BIGTERVIEW 추론 엔진은 단순한 질문 생성 시스템이 아니라,

> **입력 통제 → 전략 설계 → 문맥 강화 → 행동 제약 → 출력 정제 → 장애 복구**

까지 이어지는 **다층 방어형 지능 면접 아키텍처**입니다.

이는 LLM 기반 서비스에서 가장 중요한
✔ 환각 방지
✔ 맥락 유지
✔ 사용자 경험 안정성
✔ 시스템 신뢰성

을 동시에 달성하기 위한 정교한 설계라고 평가할 수 있습니다.
