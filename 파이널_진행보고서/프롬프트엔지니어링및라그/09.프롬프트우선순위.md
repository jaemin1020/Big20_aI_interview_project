# 오류 분석 및 설계 보고서: 프롬프트 우선순위 및 계층 구조 분석 (09)

## 1. 개요 (Overview)

본 보고서는 AI 면접관의 질문 생성 로직에서 발생하는 **"기술 질문 단계(6~7번)임에도 불구하고 프롬프트에 인재상이 포함되는 현상"**의 원인을 분석하고, 시스템이 프롬프트 내에서 정보의 우선순위를 어떻게 결정하는지 그 설계 구조를 상세히 기록합니다.

---

## 2. 프롬프트 계층 구조 (Prompt Hierarchy)

현재 시스템은 3단계의 계층화된 프롬프트 체계를 사용합니다. 데이터는 하위 단계로 갈수록 구체화되며, 하위 지침이 상위 지침을 오버라이드(Override)하도록 설계되었습니다.

### [계층 1] 전역 템플릿 (Global Template)

`question_generator.py`에 정의된 기본 틀로, 모든 단계에서 공통으로 LLM에 전달됩니다. 여기에는 **인재상**이 페르소나의 일부로 고정되어 있습니다.

```python
# question_generator.py (Line 44-65)
PROMPT_TEMPLATE = """[|user|]당신은 전문적인 지식과 공정한 태도를 겸비한 베테랑 AI 면접관입니다.
다음 지침에 따라 지원자의 잠재력을 예리하게 파악할 수 있는 **단 하나의 질문**을 생성하십시오.

### [면접 전략 및 페르소나]
- 평가 대상 직무: {target_role}
- 핵심 인재상: {company_ideal}  <-- 모든 단계에서 LLM에 제공됨
- 면접 단계: {stage_name} ({guide})

### [참고 문맥: 지원자 정보 및 이전 답변]
{context}

### [실시간 핵심 임무]
- 수행 과업: {mode_task_instruction}
- 실행 상세: {mode_instruction}
- 전역 제약: {global_constraint}
...
"""
```

### [계층 2] 스테이지별 가이드 (Stage-Specific Guide)

`interview_scenario_transition.py`에 정의된 내용으로, 각 단계의 '정체성'을 결정합니다.

```python
# 6번 단계 (기술 심층)
"guide": "이전 답변에서 가장 핵심적인 기술 키워드를 하나 찾아내십시오. ... {키워드}라는 개념은 무엇이고 어떻게 활용하셨나요?"

# 9번 단계 (인성/협업)
"guide": "회사의 인재상인 '{company_ideal}'의 핵심 가치를 바탕으로... 인재상의 정신을 어떻게 실천하는지 확인하십시오."
```

### [계층 3] 런타임 제어 지시 (Runtime Mode Instructions)

`question_generator.py`에서 실행 시점에 동적으로 생성되는 가장 강력한 지시어입니다. LLM이 최종적으로 무엇을 '출력'할지 결정하는 열쇠입니다.

---

## 3. 현상 분석: 왜 7번 질문 프롬프트에 인재상이 노출되는가?

랭스미스(LangSmith) 로그에서 7번 질문 생성 시 인재상이 보이는 것은 **환각이나 오류가 아닌 정상적인 '배경지식 제공'** 과정입니다.

### 7번 질문 생성 시의 실제 파라미터 상태:

- **`company_ideal`**: (끊임없는 열정... 창의와 혁신...) -> **[배경 정보]**
- **`mode_task_instruction`**: "제공된 정보를 분석하여 가장 예리한 꼬리질문 하나를 생성하십시오. 지원자의 마지막 답변 내용에서 구체적인 사실 관계를 확인하고 논리적 허점을 찌르는 질문을 하십시오." -> **[실제 명령]**

### 우선순위 작동 원리 (Conflict Resolution):

1. **Persona Build**: LLM은 자신이 '삼성전자의 인재상을 잘 아는 면접관'임을 인식합니다.
2. **Instruction Conflict**: `company_ideal`은 "창의와 혁신"을 말하고 있고, `mode_task_instruction`은 "기술적 허점을 찌르라"고 합니다.
3. **Priority Selection**: 시스템은 `mode_task_instruction`과 `global_constraint`를 프롬프트의 가장 하단(Assistant 답변 바로 직전)에 배치하여 LLM이 **가장 최근에 받은 명령**을 최우선으로 따르게 합니다.

---

## 4. 단계별 우선순위 조정 로직 (Code Analysis)

`question_generator.py`에서는 다음과 같이 단계에 따라 명령의 강도를 조절합니다.

```python
# question_generator.py (Line 422-442)

# 1. 인성 면접 단계(9~14)일 때: 인재상 우선순위 격상
if is_narrative:
    global_constraint = "인성 단계입니다. **코드, 설계, 개발과 같은 직무 단어를 사용하지 말고**, 태도와 가치관을 인용하여 짧게 질문하십시오."
    # -> 이 지시어가 들어가는 순간, 상위 템플릿의 '기술 직무' 페르소나보다 '인재상'이 우선순위를 갖게 됨.

# 2. 기술 면접 및 꼬리질문 단계일 때: 기술 키워드 우선순위 격상
elif s_type == 'followup':
    mode_instruction = "이 단계는 꼬리질문입니다. 답변 요약과 질문을 하나의 문장으로 결합하여 딱 하나의 질문으로 생성하십시오."
    # -> 상위에 인재상이 있더라도, '답변 요약'과 '단일 기술 질문'에만 집중하게 됨.
```

---

## 5. 결론 및 시사점

1. **정보의 상주성**: 인재상은 모든 단계에서 제공됩니다. 이는 AI 면접관이 기술 질문을 할 때도 "우리 회사 인재상에 비추어 볼 때 이런 기술적 태도가 중요한가?"를 잠재적으로 고려하게 하기 위함입니다.
2. **강제적 제어**: 하지만 실제 출력물(질문)이 기술 중심인지 인성 중심인지는 `mode_task_instruction`과 `global_constraint`라는 **'최종 명령 계층'**에서 완벽하게 제어됩니다.
3. **설계 의도**: 이 구조는 AI가 단순히 질문만 던지는 기계가 아니라, 기업의 철학을 기저에 깔고 있는 **'일관된 페르소나'**를 유지하면서도 각 단계의 목적에 충실하게 반응하도록 유도한 결과입니다.

---

## 6. 최종 명령 및 행동 강령 계층 분석

**`mode_task_instruction`과 `global_constraint`는 사실상 LLM에게 내리는 '최종 명령'이자 '행동 강령' 계층**입니다. 그렇게 부를 수 있는 이유는 크게 세 가지 설계 의도 때문입니다.

### 1. 프롬프트 내 위치의 선점성 (Recency Bias)

LLM은 프롬프트의 앞부분보다 **뒷부분(끝부분)에 나오는 지시사항을 더 강력하게 기억하고 따르는 경향**이 있습니다.

* **상위(배경)**: "당신은 면접관이고, 인재상은 이렇습니다..." (배경 설명)
* **하단(명령)**: "지금 당장 기술 용어는 빼고 질문만 하세요!" (**최종 명령**)
* 우리 시스템의 `PROMPT_TEMPLATE`에서 이 변수들은 `[실시간 핵심 임무]` 섹션에 위치하며, 이는 AI가 답변을 출력(`[|assistant|]`)하기 직전에 읽는 가장 마지막 지시사항 그룹입니다.

### 2. 구체적인 행동 제약 (Actionable Constraints)

상위 계층인 `guide`나 `persona`가 "무엇을(What)" 하라는 거시적인 방향이라면, 이 계층은 **"어떻게(How)"** 하라는 미시적인 제어를 담당합니다.

* **`mode_task_instruction`**: "논리적 허점을 찔러라", "설명 요청을 해라" 등 **공격적인 전술** 결정.
* **`global_constraint`**: "코드 단어 금지", "80자 이내", "요약 절대 금지" 등 **강력한 출력 제한**.

### 3. 실시간 동적 대응 (Runtime Overriding)

이 계층은 코드상에서 **가장 마지막에 결정**됩니다.

* 예를 들어, 7번 기술 단계임에도 불구하고 사용자가 "몰라요"라고 답하면, 코드 로직이 `mode_task_instruction`을 **"다시 설명 요청하거나 주제 전환"**으로 덮어써 버립니다.
* 이때 프롬프트 상단에는 여전히 "7번 기술 단계 가이드"가 남아있지만, AI는 하단의 **"주제 전환" 명령을 최종적으로 따르게** 됩니다.

---

### 💡 비유하자면:

* **인재상/페르소나**: 면접관의 **'인격과 가치관'** (늘 마음속에 품고 있음)
* **스테이지 가이드**: 오늘 면접의 **'전체 일정표'** (진행할 순서)
* **`mode_task_instruction` / `global_constraint`**: 면접 도중 귀엣말로 전해 듣는 **'감독관의 쪽지'** ("지금 당장 기술 얘기는 그만하고 인성 질문으로 넘어가세요!")
