# ğŸ¢ AI ë©´ì ‘ ë°±ì—”ë“œ ê´€ì œíƒ‘: `main.py` ì™„ë²½ í•´ë¶€ ë° ì „ì²´ ì½”ë“œ

`main.py`ëŠ” AI ë©´ì ‘ ì„œë¹„ìŠ¤ ë°±ì—”ë“œì˜ **'ì‚¬ì¥ë‹˜(CEO)'**ì´ì **'ê´€ì œíƒ‘(Control Tower)'** ì—­í• ì„ í•˜ëŠ” í•µì‹¬ íŒŒì¼ì…ë‹ˆë‹¤.
ì§ì ‘ ì‹¤ë¬´(ì´ë ¥ì„œ íŒŒì‹±, ìœ ì € ê´€ë¦¬ ë“±)ë¥¼ ë‹´ë‹¹í•˜ì§€ ì•Šê³ , ì„œë²„ì˜ ë¼ˆëŒ€ë¥¼ ì„¸ìš°ë©° ê° ë¶€ì„œ(Router)ë¡œ ì—…ë¬´ë¥¼ ë°°ë¶„í•˜ëŠ” í•„ìˆ˜ ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

---

## ğŸ“Œ 1. `main.py`ì˜ 7ê°€ì§€ í•µì‹¬ ì„ë¬´

### 1) ì„œë²„ ë³¸ì²´ ìƒì„± (App Initialization)

* **ì—­í• :** ë©”ëª¨ë¦¬ ìƒì— ì›¹ ì„œë²„ì˜ ëª¨ë“  ì„¤ì •ê³¼ API ì£¼ì†Œë¡ì„ ë‹´ì•„ë‘˜ ê±°ëŒ€í•œ ë³¸ì²´(`app`)ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
* **ì˜ë¯¸:** ì´ í•œ ì¤„(`app = FastAPI()`)ì´ ì—†ìœ¼ë©´ ì„œë²„ëŠ” ì¡´ì¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

### 2) ê¸€ë¡œë²Œ ì˜ˆì™¸ ì²˜ë¦¬ (Global Exception Handler)

* **ì—­í• :** ì‚¬ìš©ìê°€ ê·œê²©ì— ë§ì§€ ì•ŠëŠ” ë°ì´í„°ë¥¼ ë³´ëƒˆì„ ë•Œ ì„œë²„ê°€ ë‹¤ìš´ë˜ëŠ” ê²ƒì„ ë§‰ëŠ” ë°©ì–´ë§‰ì…ë‹ˆë‹¤.
* **ì˜ë¯¸:** ë¬´ì‘ì • ì„œë²„ë¥¼ ë©ˆì¶”ì§€ ì•Šê³ , **"ë³´ë‚´ì‹  ë°ì´í„° í˜•ì‹ì´ í‹€ë ¸ìŠµë‹ˆë‹¤"**ë¼ë©° `422` ìƒíƒœ ì½”ë“œì™€ í•¨ê»˜ ì¹œì ˆí•œ í”¼ë“œë°±ì„ í”„ë¡ íŠ¸ì—”ë“œì— ë°˜í™˜í•©ë‹ˆë‹¤.

### 3) ì„œë²„ êµ¬ë™ ì‹œ DB ì´ˆê¸°í™” (Startup Event)

* **ì—­í• :** ì„œë²„ í”„ë¡œì„¸ìŠ¤ê°€ ì¼œì§€ê³  ì™¸ë¶€ ìš”ì²­ì„ ë°›ê¸° ì§ì „ì— ë”± í•œ ë²ˆ ì‹¤í–‰ë˜ëŠ” ìƒëª…ì£¼ê¸°(Lifecycle) ì´ë²¤íŠ¸ì…ë‹ˆë‹¤.
* **ì˜ë¯¸:** DB ì—°ê²°ì´ ì •ìƒì ì¸ì§€, í•„ìš”í•œ í…Œì´ë¸”ì´ ì˜ ìƒì„±ë˜ì–´ ìˆëŠ”ì§€ ì‚¬ì „ì— ì ê²€í•˜ëŠ” 'ì•„ì¹¨ ì¡°íšŒ' ì—­í• ì„ í•©ë‹ˆë‹¤.

### 4) ì¶œì…êµ­ ê´€ë¦¬ ë° ë³´ì•ˆ (CORS Middleware)

* **ì—­í• :** í”„ë¡ íŠ¸ì—”ë“œ(`localhost:3000`)ì™€ ë°±ì—”ë“œ(`localhost:8000`) ê°„ì˜ ë„ë©”ì¸ì´ ë‹¤ë¥¼ ë•Œ ë°œìƒí•˜ëŠ” ë¸Œë¼ìš°ì €ì˜ ë³´ì•ˆ ì°¨ë‹¨(CORS)ì„ í•´ê²°í•©ë‹ˆë‹¤.
* **ì˜ë¯¸:** ì„œë²„ ì‘ë‹µ í—¤ë”ì— í—ˆê°€ì¦ì„ ë¶™ì—¬ì£¼ì–´ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ìš”ì²­ì„ í†µê³¼ì‹œí‚¤ëŠ” ìˆ˜ë¬¸ì¥ ì—­í• ì…ë‹ˆë‹¤.

### 5) í•µì‹¬: ë¶€ì„œë³„ ë¼ìš°í„° ì—°ê²° (Router Registration)

* **ì—­í• :** ë„ë©”ì¸ë³„ë¡œ ë¶„ë¦¬ëœ ë‹¤ë¥¸ íŒŒì´ì¬ íŒŒì¼(`routes/resumes.py` ë“±)ì˜ ê¸°ëŠ¥ë“¤ì„ ë©”ì¸ `app`ì— ì¡°ë¦½í•©ë‹ˆë‹¤.
* **ì˜ë¯¸:** ê´€ì œíƒ‘ì—ì„œ ë“¤ì–´ì˜¨ ìš”ì²­ì˜ ì£¼ì†Œë¥¼ ë³´ê³  ì•Œë§ì€ ë‹´ë‹¹ ë¶€ì„œë¡œ ê¸¸ì„ ì•ˆë‚´í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ `main.py`ê°€ ë¹„ëŒ€í•´ì§€ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤(ëª¨ë“ˆí™”).

### 6) ì •ì  íŒŒì¼ ì„œë¹™ (Static Files Mounting)

* **ì—­í• :** íŠ¹ì • URL ê²½ë¡œë¥¼ ì„œë²„ í•˜ë“œë””ìŠ¤í¬ì˜ ì‹¤ì œ í´ë”ì™€ 1:1ë¡œ ì§ê²°ì‹œí‚µë‹ˆë‹¤.
* **ì˜ë¯¸:** íŒŒì´ì¬ ë¡œì§ì„ ê±°ì¹˜ì§€ ì•Šê³  ì˜¤ë””ì˜¤(.wav)ë‚˜ ì´ë¯¸ì§€ íŒŒì¼ì„ ê³ ì†ìœ¼ë¡œ í”„ë¡ íŠ¸ì—”ë“œì— ì „ì†¡í•©ë‹ˆë‹¤.

### 7) ì„œë²„ ì—”ì§„ êµ¬ë™ ë° í—¬ìŠ¤ ì²´í¬ (Uvicorn & Health Check)

* **ì—­í• :** í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ ì„œë²„ê°€ ì‚´ì•„ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” API(`/`)ë¥¼ ì œê³µí•˜ê³ , ë¹„ë™ê¸° ì›¹ ì„œë²„ ì—”ì§„(Uvicorn)ì„ ê°€ë™í•©ë‹ˆë‹¤.

---

## ğŸ’» 2. ì •ëˆëœ `main.py` ì „ì²´ ì½”ë“œ

(â€» êµ¬ë²„ì „ ì´ë ¥ì„œ ì²˜ë¦¬ ì½”ë“œëŠ” ì£¼ì„ ì²˜ë¦¬í•˜ì—¬ `routes/resumes.py`ì™€ ì¶©ëŒí•˜ì§€ ì•Šë„ë¡ ì•ˆì „í•˜ê²Œ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.)

```python
from fastapi import FastAPI, Depends, HTTPException, status, UploadFile, File, Request
from fastapi.exceptions import RequestValidationError
from fastapi.responses import JSONResponse
from fastapi.security import OAuth2PasswordRequestForm
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from sqlmodel import Session, select
from celery import Celery
from datetime import datetime, timedelta
from typing import List
import logging
import os
import shutil
from pathlib import Path

# DB ì„¤ì •
from database import init_db, get_session
# DB í…Œì´ë¸” ëª¨ë“ˆ ì„í¬íŠ¸
from db_models import (
    User, UserCreate, UserLogin, Company,
    Interview, InterviewCreate, InterviewResponse, InterviewStatus,
    Question, QuestionCategory, QuestionDifficulty,
    Transcript, TranscriptCreate, Speaker,
    EvaluationReport, EvaluationReportResponse,
    Resume
)

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("Backend-Core")

# 1. ì„œë²„ ë³¸ì²´ ìƒì„±
app = FastAPI(title="AI Interview Backend v2.0")

# 2. ê¸€ë¡œë²Œ ì˜ˆì™¸ ì²˜ë¦¬ê¸°
@app.exception_handler(RequestValidationError)
async def validation_exception_handler(request: Request, exc: RequestValidationError):
    import json
    try:
        body = await request.json()
    except:
        body = "Could not parse body"
    logger.error(f"Validation Error: {exc}")
    logger.error(f"Request Body: {body}")
    return JSONResponse(
        status_code=422,
        content={"detail": exc.errors(), "body": body},
    )

# 3. DB ì´ˆê¸°í™” (Startup Event)
@app.on_event("startup")
def on_startup():
    init_db()
    logger.info("âœ… Database initialized with new schema")

# 4. CORS ì„¤ì • (ì¶œì…êµ­ ê´€ë¦¬)
ALLOWED_ORIGINS = os.getenv("ALLOWED_ORIGINS", "http://localhost:3000").split(",")
app.add_middleware(
    CORSMiddleware,
    allow_origins=ALLOWED_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Celery ì„¤ì • (ì¤‘ì•™í™”ëœ ì„¤ì • ë¡œë“œ)
from celery_app import celery_app

# Router Imports (ë¶€ì„œë³„ ëª…ë‹¨ ê°€ì ¸ì˜¤ê¸°)
from routes.auth import router as auth_router
from routes.users import router as users_router
from routes.interviews import router as interviews_router
from routes.transcripts import router as transcripts_router
from routes.stt import router as stt_router
from routes.companies import router as companies_router
# [ì¤‘ìš”] ìƒˆë¡œ ë§Œë“  ì´ë ¥ì„œ ì „ìš© ë¼ìš°í„°(ì¸ì‚¬íŒ€) ì„í¬íŠ¸!
from routes.resumes import router as resumes_router 

# Auth Utils
from utils.auth_utils import get_current_user

# 5. Router Registration (ê° ë¶€ì„œ ë°°ì¹˜)
app.include_router(auth_router)
app.include_router(users_router)
app.include_router(interviews_router)
app.include_router(transcripts_router)
app.include_router(stt_router)
app.include_router(companies_router)
app.include_router(resumes_router) # ì´ë ¥ì„œ ë¼ìš°í„° ë“±ë¡ ì™„ë£Œ!

# 6. ì •ì  íŒŒì¼ ë§ˆìš´íŠ¸ (TTS ì˜¤ë””ì˜¤)
TTS_DIR = Path("./uploads/tts")
TTS_DIR.mkdir(parents=True, exist_ok=True)
app.mount("/uploads/tts", StaticFiles(directory=str(TTS_DIR)), name="tts_audio")


# ==================== Resume Endpoints (Legacy - ì‚¬ìš© ì•ˆ í•¨) ====================
"""
[ì•ˆë‚´] ì•„ë˜ ì½”ë“œëŠ” êµ¬ë²„ì „(Legacy) ì´ë ¥ì„œ ì²˜ë¦¬ ë¡œì§ì…ë‹ˆë‹¤. 
í˜„ì¬ëŠ” ê¸°ëŠ¥ì´ í™•ì¥ë˜ì–´ `routes/resumes.py` ëª¨ë“ˆë¡œ ëª¨ë‘ ì´ê´€ë˜ì—ˆìŠµë‹ˆë‹¤.
ë¼ìš°í„° ì¶©ëŒ ë°©ì§€ ë° ìœ ì§€ë³´ìˆ˜ë¥¼ ìœ„í•´ ì „ì²´ ì£¼ì„ ì²˜ë¦¬í•´ ë‘ì—ˆìŠµë‹ˆë‹¤.

@app.post("/resumes/upload", tags=["resumes"])
async def upload_resume(...):
    pass

@app.get("/resumes/{resume_id}", tags=["resumes"])
async def get_resume(...):
    pass

@app.get("/api/resumes/{resume_id}/pdf", tags=["resumes"])
async def get_resume_pdf(...):
    pass
"""
# ==============================================================================


# 7. ì„œë²„ ìƒíƒœ í™•ì¸ (Health Check)
@app.get("/")
async def root():
    return {
        "service": "AI Interview Backend v2.0",
        "status": "running",
        "database": "PostgreSQL with pgvector",
        "features": ["real-time STT", "emotion analysis", "AI evaluation"]
    }

# ì„œë²„ ì‹¤í–‰ ì—”ì§„ êµ¬ë™
if __name__ == "__main__":
    import uvicorn
    uvicorn.run("main:app", host="0.0.0.0", port=8000, reload=True)
```
